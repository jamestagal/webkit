# Codebase Concerns

**Analysis Date:** 2026-01-22

## Tech Debt

**Large Remote Function Files:**
- Issue: Several remote function files exceed 1000 lines, making them difficult to maintain and test
- Files:
  - `service-client/src/lib/api/invoices.remote.ts` (1489 lines)
  - `service-client/src/lib/api/contracts.remote.ts` (1408 lines)
  - `service-client/src/lib/api/proposals.remote.ts` (1322 lines)
  - `service-client/src/lib/api/forms.remote.ts` (1129 lines)
- Impact: Code navigation, refactoring, and testing become harder; single files bundle unrelated operations
- Fix approach: Extract related functions into separate modules (e.g., split contracts into `contract-crud.remote.ts` and `contract-signing.remote.ts`); keep shared helpers in `contracts.helpers.ts`

**Drizzle Schema Size:**
- Issue: `service-client/src/lib/server/schema.ts` is 1615 lines in a single file with all table definitions mixed together
- Files: `service-client/src/lib/server/schema.ts`
- Impact: Difficult to find specific tables; schema validation and IDE navigation slower; high risk of circular dependencies
- Fix approach: Split into per-domain schema files (`schemas/agencies.ts`, `schemas/contracts.ts`, etc.) and re-export from index

**Fire-and-Forget Database Updates:**
- Issue: View tracking and status updates silently catch errors without logging or monitoring
- Files:
  - `service-client/src/routes/c/[slug]/+page.server.ts` (lines 43-47)
  - `service-client/src/routes/p/[slug]/+page.server.ts` (line 56)
  - `service-client/src/routes/i/[slug]/+page.server.ts` (line 39)
- Impact: If view count updates fail, no notification occurs; metrics become unreliable
- Fix approach: Implement proper error logging via Winston logger; consider async job queue (NATS) for non-critical updates

**Type Safety with `any` and `unknown`:**
- Issue: 255+ instances of `any` or `unknown` types in TypeScript codebase
- Files: Throughout `service-client/src`
- Impact: Loss of type checking; potential runtime errors; harder refactoring
- Fix approach: Gradual typing effort; prioritize critical paths first (auth, data pipeline); use `@typescript-eslint/no-explicit-any` ESLint rule to prevent new instances

## Known Bugs

**Missing Email Notifications:**
- Symptoms: Contract/invoice signing and sending produces no email to clients or agencies
- Files:
  - `service-client/src/routes/c/[slug]/+page.server.ts` (lines 154-155)
  - `service-client/src/lib/api/contracts.remote.ts` (lines 777, 815, 828, 854, 1306, 1346-1347)
- Trigger: When client signs contract or contract is sent
- Workaround: None; functionality incomplete
- Priority: HIGH - Blocks client communication flow
- Note: Email infrastructure exists (`service-client/src/lib/api/email.remote.ts`) but integration not completed

**Incomplete Form Builder Filters:**
- Symptoms: Consultation list filtering doesn't support sorting or advanced filters
- Files: `app/service-core/rest/consultation_handler.go` (lines 147, 213)
- Trigger: When accessing consultation list with filter parameters
- Workaround: Basic pagination works, but no filtering by industry/urgency/etc.
- Priority: MEDIUM - Users must manually search through all consultations

## Security Considerations

**HTML Sanitization in Contract/Proposal Content:**
- Risk: {@html} tags render user-generated contract terms, schedules, and proposal content without sanitization
- Files:
  - `service-client/src/routes/c/[slug]/+page.svelte` (lines 216, 281)
  - `service-client/src/routes/p/[slug]/+page.svelte` (lines multiple)
  - `service-client/src/routes/(app)/[agencySlug]/contracts/[contractId]/+page.svelte`
- Current mitigation: Content is generated by AI (Claude) and controlled by agency admins; not user-submitted from public form
- Recommendations:
  - Implement HTML sanitization library (e.g., `sanitize-html`) for any future user-editable content
  - Document this assumption in code comments
  - Add Content Security Policy header restricting inline script execution

**Public Contract/Invoice/Proposal View without Authentication:**
- Risk: Anyone with the slug URL can view contracts, invoices, and proposals
- Files:
  - `service-client/src/routes/c/[slug]/+page.server.ts` (unauthenticated load)
  - `service-client/src/routes/i/[slug]/+page.server.ts` (unauthenticated load)
  - `service-client/src/routes/p/[slug]/+page.server.ts` (unauthenticated load)
- Current mitigation: Slugs are generated by nanoid (12 characters) - statistically hard to guess; expiration via `validUntil` field
- Recommendations:
  - Consider token-based access (send URL with token in email)
  - Add audit logging of who viewed contracts (already tracks IP, timestamp)
  - Implement view rate limiting to prevent slug enumeration attacks

**SQL Injection via Raw SQL:**
- Risk: Several `sql\`` template literals construct dynamic queries
- Files:
  - `service-client/src/lib/api/contracts.remote.ts` (line 380)
  - `service-client/src/lib/api/proposals.remote.ts` (line 282)
  - `service-client/src/lib/api/super-admin.remote.ts` (multiple)
  - `service-client/src/routes/c/[slug]/+page.server.ts` (line 34)
- Current mitigation: Drizzle-ORM properly escapes parameters via parameterized queries; no user input directly interpolated
- Recommendations: Maintain this pattern; never concatenate user input into `sql\`` templates; use Drizzle's built-in helpers

**Cross-Tenant Data Access:**
- Risk: Multi-tenant isolation relies on `withAgencyScope()` and permission checks
- Files: `service-client/src/lib/server/db-helpers.ts`, `service-client/src/lib/server/permissions.ts`
- Current mitigation: All queries use `eq(table.agencyId, agencyId)` filter; role-based access control in place
- Recommendations:
  - Add integration tests verifying one agency cannot access another's data
  - Implement query-level audit logging for sensitive operations
  - Regularly audit permission matrix for edge cases

**Anthropic API Key Exposure:**
- Risk: `ANTHROPIC_API_KEY` environment variable in production could leak via logs or error messages
- Files: `service-client/src/lib/server/services/claude.service.ts` (line 33)
- Current mitigation: Env variable not logged; error handling doesn't expose key
- Recommendations:
  - Ensure logs never include API keys (no debug logging of request bodies)
  - Monitor for accidental key commits via pre-commit hooks
  - Rotate API key periodically; implement key rotation mechanism

## Performance Bottlenecks

**SELECT * Queries in Go Backend:**
- Problem: Database migrations and queries use `SELECT *` on large tables like `users`
- Files: `app/service-core/storage/query_postgres.sql` (lines 13-14, 17-26, 65-68, 76-87, etc.)
- Cause: Generated by sqlc from query definitions; fetches all columns even when only subset needed
- Impact: Larger result sets; slower network transfer; breaking changes when columns added
- Improvement path: Refactor sqlc queries to explicitly list needed columns; reduces payload size; easier schema evolution

**Unindexed Database Queries:**
- Problem: Filter operations on `consultations`, `proposals`, `contracts` by status/date may lack indexes
- Files: Database schema in `app/service-core/storage/schema_*.sql` (need to verify)
- Impact: List queries become O(n) scans on large datasets
- Improvement path: Profile queries with `EXPLAIN ANALYZE`; add indexes on frequently filtered columns (status, createdAt, agencyId)

**Frontend Test Coverage:**
- Problem: Only 7 test files for 174 source files (4% coverage ratio)
- Files:
  - `service-client/src/lib/api/consultation.remote.test.ts` (761 lines)
  - `service-client/src/lib/tests/*.test.ts` (multiple)
- Impact: High risk of regression; refactoring requires manual verification
- Improvement path: Prioritize critical paths: remote functions (API), permissions, auth flow

**Large Proposal/Contract Generation Service:**
- Problem: `service-client/src/lib/server/services/data-pipeline.service.ts` (750 lines) handles merge field resolution
- Impact: Complex domain logic bundled with infrastructure; harder to test in isolation
- Improvement path: Extract merge field resolution into pure functions; separate data transformation from database access

**Console Log Accumulation:**
- Problem: 147 console.log/error/warn calls throughout codebase for debugging
- Files: Throughout `service-client/src`, particularly in `claude.service.ts` (lines 264-296)
- Impact: Production logs become noisy; impacts performance; hard to correlate with structured logging
- Fix approach: Remove debug logs before release; use Winston structured logging throughout; implement log levels

## Fragile Areas

**Remote Function Export Restrictions:**
- Files: `service-client/src/lib/api/*.remote.ts`
- Why fragile: SvelteKit validates ALL exports must be remote functions (`query`, `command`, `form`, `prerender`); any type exports cause runtime error
- Safe modification: Use separate `.types.ts` files for type exports (pattern already documented in CLAUDE.md); only export remote functions
- Test coverage: No automated tests verify this constraint; relies on developer knowledge
- Risk: New developer might export a helper function or type, breaking at runtime only

**Database Migration Ordering:**
- Files: `/migrations/*.sql` (11+ migrations with cross-dependencies)
- Why fragile: Migrations executed in filename order; no explicit dependency tracking
- Safe modification: Number migrations sequentially; verify each migration is idempotent (uses `IF NOT EXISTS`); test locally before deploying
- Test coverage: Manual testing only; no integration test for full migration sequence
- Risk: Missing migration or misordered file causes production deployment failure

**Agency Config Store State:**
- Files: `service-client/src/lib/stores/agency-config.svelte.ts` (module-level state)
- Why fragile: Relies on `+layout.server.ts` calling `setAgencyConfig()` early; if layout doesn't load or changes, forms lose access to custom options
- Safe modification: Always load config in root layout; add fallback defaults in form components; test with missing config
- Test coverage: No unit tests for store fallback behavior
- Risk: Agencies using custom form options suddenly see defaults; migration path unclear

**Contract HTML Generation:**
- Files: `service-client/src/lib/api/contracts.remote.ts` (generates HTML from JSON template)
- Why fragile: HTML generation logic not extracted; tightly coupled to contract data model
- Safe modification: Any change to contract schema requires updating HTML template logic; test on multiple contract configurations
- Test coverage: No automated tests for HTML output; only manual verification
- Risk: Schema change breaks HTML rendering; client sees corrupted contract

**Public Document Signing URLs:**
- Files: `service-client/src/routes/c/[slug]/+page.server.ts` (slug-based access)
- Why fragile: Security relies on slug uniqueness (12-char nanoid); no rate limiting; no request signing
- Safe modification: Before changing slug generation, ensure backward compatibility with existing URLs
- Test coverage: No tests for slug collision detection or URL invalidation
- Risk: High-entropy assumption could be violated if nanoid implementation changes

## Scaling Limits

**Single PostgreSQL Database:**
- Current capacity: Shared database with agency-scoped rows; no sharding or replication mentioned
- Limit: Horizontal scaling limited by single database; write throughput capped by ACID guarantees
- Scaling path: Implement read replicas for reporting queries; consider database sharding by agency_id if 1000+ agencies

**In-Memory Form Template Caching:**
- Current capacity: Form templates and options loaded and cached in SvelteKit memory
- Limit: Memory footprint grows with number of agencies/templates; no cache eviction policy
- Scaling path: Implement Redis-based cache with TTL; add cache invalidation on template updates

**NATS Message Queue:**
- Current capacity: Single NATS instance for cross-service communication (visible in docker-compose)
- Limit: NATS not configured for clustering; single point of failure
- Scaling path: Set up NATS JetStream cluster for durability; implement dead-letter queues for failed messages

**Email Sending Rate:**
- Current capacity: `email.remote.ts` queues emails; no rate limiting visible
- Limit: If all users send invoices simultaneously, SMTP server may rate-limit or reject
- Scaling path: Implement email queue with exponential backoff (NATS topic); batch emails by agency

## Dependencies at Risk

**Zod + Valibot Coexistence:**
- Risk: Package.json includes both `zod` and `valibot` (0.45.1); codebase favors Valibot but Zod still imported
- Files: `service-client/src/lib/api/*.remote.ts` (uses Valibot); `service-client/package.json` (has both)
- Impact: Unused dependency increases bundle size; inconsistency in validation approach
- Migration plan: Audit for any remaining Zod usage; remove Zod dependency; update all schemas to Valibot pattern

**Anthropic SDK Version:**
- Risk: `@anthropic-ai/sdk` pinned to 0.71.2; major version bumps could introduce breaking changes
- Files: `service-client/src/lib/server/services/claude.service.ts`
- Impact: Lag behind API improvements; potential vulnerability if older SDK version has security issues
- Migration plan: Set up automated dependency updates; test Claude integration against latest SDK quarterly

**Node Adapter vs Cloudflare Adapter:**
- Risk: Package has both `@sveltejs/adapter-cloudflare` (7.2.4) and `@sveltejs/adapter-node` (5.4.0)
- Files: `svelte.config.js`, `service-client/package.json`
- Impact: Confusion about deployment target; different database/env handling between adapters
- Migration plan: Remove unused adapter; clarify deployment target (Node-based VPS per CLAUDE.md)

**Winston Logger Outdated:**
- Risk: Winston (3.15.0) is older; missing features in newer versions
- Files: `service-client/package.json`
- Impact: Limited structured logging features; potential performance issues with large log volumes
- Migration plan: Update to latest Winston; implement log aggregation (Grafana Loki per deployment docs)

## Missing Critical Features

**Email Notification System:**
- Problem: Email infrastructure partially implemented but not wired to signing, sending, or key lifecycle events
- Blocks: Client communication; invoice payment reminders; contract expiration warnings
- Estimate: ~2-3 days to implement; endpoints exist, just need to call them from remote functions

**Advanced Consultation Filtering:**
- Problem: Consultation handler has TODO comments for sort/filter implementation
- Blocks: Agencies with 100+ consultations cannot efficiently search
- Estimate: ~1 day to implement with database indexes

**Form Submission Notifications:**
- Problem: Form builder has submission table but no notification when client submits
- Blocks: Agencies unaware of submissions without manual checking
- Estimate: ~1 day to add email/webhook notifications

**Proposal Expiration Warnings:**
- Problem: No automatic email when proposal validity window closes
- Blocks: Clients may try to accept expired proposals
- Estimate: ~1 day to implement (requires background job scheduler)

## Test Coverage Gaps

**Database Layer Testing:**
- What's not tested: Schema migrations, foreign key constraints, agency isolation
- Files: `app/service-core/storage/` (schema and migrations)
- Risk: Migration failures on production; data corruption via cross-tenant access
- Priority: HIGH - Data integrity is critical

**Permission Matrix Testing:**
- What's not tested: All role/resource combinations; edge cases like deleted users or suspended agencies
- Files: `service-client/src/lib/server/permissions.ts` (506 lines, no test file)
- Risk: Unauthorized access; privilege escalation
- Priority: HIGH - Security-critical

**Remote Function Integration:**
- What's not tested: Most remote functions lack unit tests; only `consultation.remote.test.ts` exists
- Files: `service-client/src/lib/api/` (9 remote function files, 1 test file)
- Risk: Breaking changes on refactoring; API contract violations
- Priority: MEDIUM - Impacts client-facing functionality

**Email Template Rendering:**
- What's not tested: Email HTML output; merge field substitution; encoding of special characters
- Files: `service-client/src/lib/templates/email-templates.ts` (922 lines, no tests)
- Risk: Broken emails in production; merge field tags visible to clients
- Priority: MEDIUM - User-facing quality issue

**Stripe Integration:**
- What's not tested: Payment flow; webhook signature verification; subscription state transitions
- Files: `service-client/src/lib/api/stripe.remote.ts` (uses Stripe SDK)
- Risk: Failed payments; double-charging; webhook injection attacks
- Priority: HIGH - Financial integrity

**Error Handling Edge Cases:**
- What's not tested: Network failures, timeout recovery, partial failures in batch operations
- Files: Throughout remote functions; retry logic exists but not verified
- Risk: Stuck operations; data inconsistency after failures
- Priority: MEDIUM - System reliability

---

*Concerns audit: 2026-01-22*
