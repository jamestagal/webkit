name: PR Preview Deploy

on:
  pull_request:
    types: [labeled, synchronize, closed]

env:
  REGISTRY: ghcr.io

jobs:
  # Deploy preview environment when 'preview' label is added or PR is updated
  deploy-preview:
    if: |
      github.event.action != 'closed' &&
      contains(github.event.pull_request.labels.*.name, 'preview')
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create key files
        run: |
          echo "${{ secrets.PRIVATE_KEY_PEM }}" > app/service-core/private.pem
          echo "${{ secrets.PUBLIC_KEY_PEM }}" > app/service-core/public.pem

      - name: Build and push PR image
        uses: docker/build-push-action@v6
        with:
          context: app
          file: app/service-core/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ github.repository }}/service-core-pr:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Clean up key files
        if: always()
        run: |
          rm -f app/service-core/private.pem
          rm -f app/service-core/public.pem

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Set Kubernetes Context
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Create PR namespace and resources
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          IMAGE_TAG: ${{ env.REGISTRY }}/${{ github.repository }}/service-core-pr:pr-${{ github.event.pull_request.number }}
          DOMAIN: ${{ vars.DOMAIN }}
          CONTEXT: ${{ vars.CONTEXT }}
          WORKERS_SUBDOMAIN: ${{ vars.WORKERS_SUBDOMAIN }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          # Create namespace
          envsubst < infra/pr-environment/namespace.yaml | kubectl apply -f -

          # Create secrets
          envsubst < infra/pr-environment/secrets.yaml | kubectl apply -f -

          # Deploy PostgreSQL
          envsubst < infra/pr-environment/postgres.yaml | kubectl apply -f -

          # Wait for PostgreSQL to be ready
          kubectl wait --for=condition=ready pod -l app=postgres -n pr-$PR_NUMBER --timeout=120s

          # Deploy service-core
          envsubst < infra/pr-environment/service-core.yaml | kubectl apply -f -

          # Create ingress
          envsubst < infra/pr-environment/ingress.yaml | kubectl apply -f -

          # Wait for deployment to be ready
          kubectl rollout status deployment/service-core -n pr-$PR_NUMBER --timeout=180s

      - name: Run database migrations
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Port-forward to the PostgreSQL pod
          kubectl port-forward svc/postgres -n pr-$PR_NUMBER 5433:5432 &
          sleep 5

          # Run migrations using Atlas
          cd app/service-core/storage
          ./atlas schema apply \
            --url "postgres://postgres:postgres@localhost:5433/postgres?sslmode=disable" \
            --to "file://schema_postgres.sql" \
            --dev-url "postgres://postgres:postgres@localhost:5433/postgres?sslmode=disable" \
            --auto-approve || true

          # Kill port-forward
          pkill -f "kubectl port-forward" || true

      - name: Deploy SvelteKit to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CONTEXT: ${{ vars.CONTEXT }}
          DOMAIN: ${{ vars.DOMAIN }}
        working-directory: service-client
        run: |
          npm ci
          npm run build

          # Deploy to Cloudflare Workers with PR-specific name
          npx wrangler deploy \
            --name "pr-$PR_NUMBER-$CONTEXT" \
            --var CORE_URL:"https://pr-$PR_NUMBER-core.$DOMAIN" \
            --var CLIENT_URL:"https://pr-$PR_NUMBER-$CONTEXT.${{ vars.WORKERS_SUBDOMAIN }}.workers.dev"

      - name: Comment PR with preview URLs
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DOMAIN: ${{ vars.DOMAIN }}
          CONTEXT: ${{ vars.CONTEXT }}
          WORKERS_SUBDOMAIN: ${{ vars.WORKERS_SUBDOMAIN }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const domain = process.env.DOMAIN;
            const context = process.env.CONTEXT;
            const workersSubdomain = process.env.WORKERS_SUBDOMAIN;

            const body = `## Preview Environment Ready

            | Service | URL |
            |---------|-----|
            | Frontend | https://pr-${prNumber}-${context}.${workersSubdomain}.workers.dev |
            | Backend | https://pr-${prNumber}-core.${domain} |

            **Namespace:** \`pr-${prNumber}\`

            This preview environment will be automatically destroyed when the PR is closed or the \`preview\` label is removed.

            ---
            *Deployed at ${new Date().toISOString()}*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber)
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Environment')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber),
                body
              });
            }

  # Cleanup preview environment when PR is closed or label is removed
  cleanup-preview:
    if: |
      github.event.action == 'closed' ||
      (github.event.action == 'unlabeled' && github.event.label.name == 'preview')
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      packages: write

    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Set Kubernetes Context
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Delete PR namespace
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          kubectl delete namespace pr-$PR_NUMBER --ignore-not-found=true

      - name: Delete Cloudflare Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CONTEXT: ${{ vars.CONTEXT }}
        run: |
          npx wrangler delete --name "pr-$PR_NUMBER-$CONTEXT" --force || true

      - name: Delete container image
        uses: actions/delete-package-versions@v5
        with:
          package-name: service-core-pr
          package-type: container
          delete-only-pre-release-versions: true
        continue-on-error: true
