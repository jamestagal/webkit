{
  "id": null,
  "uid": "observability",
  "title": "Errors & Traces",
  "timezone": "browser",
  "version": 1,
  "schemaVersion": 39,
  "style": "dark",
  "tags": [
    "errors",
    "observability"
  ],
  "editable": true,
  "refresh": "30s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "30m",
      "1h"
    ]
  },
  "templating": {
    "list": [
      {
        "name": "service",
        "label": "Service",
        "type": "query",
        "query": "label_values({service_name!=\"\"}, service_name)",
        "datasource": {
          "uid": "Loki",
          "type": "loki"
        },
        "refresh": 2,
        "allValue": ".+",
        "includeAll": true,
        "multi": false,
        "current": {}
      }
    ]
  },
  "annotations": {
    "list": []
  },
  "panels": [
    {
      "type": "timeseries",
      "title": "Throughput (RPS)",
      "datasource": {
        "uid": "prometheus",
        "type": "prometheus"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (service_name) (rate(span_metrics_calls_total{service_name=~\"$service\"}[5m]))",
          "legendFormat": "{{service_name}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 20,
            "lineWidth": 1,
            "showPoints": "auto"
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 0,
        "y": 0
      }
    },
    {
      "type": "timeseries",
      "title": "Error Rate (%)",
      "datasource": {
        "uid": "prometheus",
        "type": "prometheus"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum by (service_name) (rate(span_metrics_calls_total{service_name=~\"$service\", status_code=\"STATUS_CODE_ERROR\"}[5m])) / sum by (service_name) (rate(span_metrics_calls_total{service_name=~\"$service\"}[5m])) * 100",
          "legendFormat": "{{service_name}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 20,
            "lineWidth": 1,
            "showPoints": "auto"
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 0
      }
    },
    {
      "type": "timeseries",
      "title": "p99 Latency (ms)",
      "datasource": {
        "uid": "prometheus",
        "type": "prometheus"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "histogram_quantile(0.99, sum by (le, service_name) (rate(span_metrics_duration_milliseconds_bucket{service_name=~\"$service\"}[5m])))",
          "legendFormat": "{{service_name}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 20,
            "lineWidth": 1,
            "showPoints": "auto"
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 16,
        "y": 0
      }
    },
    {
      "type": "nodeGraph",
      "title": "Service Graph",
      "datasource": {
        "uid": "tempo",
        "type": "tempo"
      },
      "targets": [
        {
          "datasource": {
            "type": "tempo",
            "uid": "tempo"
          },
          "refId": "A",
          "queryType": "serviceMap",
          "limit": 20,
          "tableType": "traces",
          "metricsQueryType": "range",
          "serviceMapUseNativeHistograms": false
        }
      ],
      "gridPos": {
        "h": 16,
        "w": 24,
        "x": 0,
        "y": 8
      },
      "options": {
        "zoomMode": "cooperative",
        "layoutAlgorithm": "layered",
        "nodes": {},
        "edges": {}
      }
    },
    {
      "type": "bargauge",
      "title": "Top Slowest Endpoints (p99)",
      "description": "Slowest gRPC methods by p99 latency across all services",
      "datasource": {
        "uid": "prometheus",
        "type": "prometheus"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, histogram_quantile(0.99, sum by (le, rpc_service, rpc_method, service_name) (increase(span_metrics_duration_milliseconds_bucket{service_name=~\"$service\", rpc_method!=\"\"}[$__range]))))",
          "legendFormat": "{{service_name}}/{{rpc_service}}/{{rpc_method}}",
          "instant": true
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 100
              },
              {
                "color": "red",
                "value": 500
              }
            ]
          },
          "mappings": []
        },
        "overrides": []
      },
      "options": {
        "orientation": "horizontal",
        "displayMode": "gradient",
        "showUnfilled": true,
        "minVizWidth": 0,
        "minVizHeight": 10
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 24
      }
    },
    {
      "type": "table",
      "title": "Tempo Traces (All)",
      "description": "Latest traces from Tempo. Click a Trace ID to open the full trace view.",
      "datasource": {
        "uid": "Tempo",
        "type": "tempo"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": {
            "uid": "Tempo",
            "type": "tempo"
          },
          "queryType": "traceql",
          "tableType": "table",
          "query": "{ resource.service.name =~ \"$service\" }"
        }
      ],
      "transformations": [
        {
          "id": "limit",
          "options": {
            "limitField": 50
          }
        },
        {
          "id": "organize",
          "options": {
            "renameByName": {
              "durationMs": "Duration (ms)",
              "rootService": "Service",
              "rootSpanName": "Root Span",
              "traceID": "Trace ID"
            }
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": false
          }
        },
        "overrides": []
      },
      "options": {
        "showHeader": true,
        "footer": {
          "show": false
        },
        "sortBy": [
          {
            "displayName": "Start time",
            "desc": true
          }
        ],
        "cellHeight": "sm"
      },
      "gridPos": {
        "h": 12,
        "w": 12,
        "x": 0,
        "y": 32
      }
    },
    {
      "type": "table",
      "title": "Tempo Traces (Errors)",
      "description": "Traces that include error spans. Click a Trace ID to open the full trace view.",
      "datasource": {
        "uid": "Tempo",
        "type": "tempo"
      },
      "targets": [
        {
          "refId": "A",
          "datasource": {
            "uid": "Tempo",
            "type": "tempo"
          },
          "queryType": "traceql",
          "tableType": "table",
          "query": "{ resource.service.name =~ \"$service\" && status = error }"
        }
      ],
      "transformations": [
        {
          "id": "limit",
          "options": {
            "limitField": 50
          }
        },
        {
          "id": "organize",
          "options": {
            "renameByName": {
              "durationMs": "Duration (ms)",
              "rootService": "Service",
              "rootSpanName": "Root Span",
              "traceID": "Trace ID"
            }
          }
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": false
          }
        },
        "overrides": []
      },
      "options": {
        "showHeader": true,
        "footer": {
          "show": false
        },
        "sortBy": [
          {
            "displayName": "Start time",
            "desc": true
          }
        ],
        "cellHeight": "sm"
      },
      "gridPos": {
        "h": 12,
        "w": 12,
        "x": 12,
        "y": 32
      }
    },
    {
      "type": "logs",
      "title": "All Logs",
      "description": "All application logs with formatted output",
      "datasource": {
        "uid": "Loki",
        "type": "loki"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "{service_name=~\"$service\"} | line_format `{{.detected_level}} | {{.scope_name}} | {{.procedure}} | {{ __line__ }}{{if .duration}} | duration={{.duration}}{{end}}{{if .remote_addr}} | from={{.remote_addr}}{{end}}`",
          "queryType": "range"
        }
      ],
      "options": {
        "showTime": true,
        "showLabels": false,
        "showCommonLabels": false,
        "wrapLogMessage": true,
        "prettifyLogMessage": false,
        "enableLogDetails": true,
        "dedupStrategy": "none",
        "sortOrder": "Descending"
      },
      "gridPos": {
        "h": 12,
        "w": 12,
        "x": 0,
        "y": 44
      }
    },
    {
      "type": "logs",
      "title": "Error Logs",
      "description": "Error logs with formatted output for easier reading",
      "datasource": {
        "uid": "Loki",
        "type": "loki"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "{service_name=~\"$service\"} | detected_level=\"error\" | line_format `ERROR | {{.scope_name}} | {{.procedure}} | {{ __line__ }}{{if .error}} | error={{.error}}{{end}}{{if .duration}} | duration={{.duration}}{{end}}`",
          "queryType": "range"
        }
      ],
      "options": {
        "showTime": true,
        "showLabels": false,
        "showCommonLabels": false,
        "wrapLogMessage": true,
        "prettifyLogMessage": false,
        "enableLogDetails": true,
        "dedupStrategy": "none",
        "sortOrder": "Descending"
      },
      "gridPos": {
        "h": 12,
        "w": 12,
        "x": 12,
        "y": 44
      }
    }
  ]
}
